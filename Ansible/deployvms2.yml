---

#Copyright 2016 ShapeBlue
#
#Licensed under the Apache License, Version 2.0 (the "License");
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing, software
#distributed under the License is distributed on an "AS IS" BASIS,
#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#See the License for the specific language governing permissions and
#limitations under the License.

- hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Request and return environment details
      env_db_manage: DBHOST={{ env_db_ip }} DBUSER={{ env_db_user }} DBPASS={{ env_db_password }} DBNAME={{ env_db_name }} ENV_UUID={{ env_uuid }} ENV_NAME={{ env_name_clean }} ENV_ZONETYPE={{ env_zonetype }} ENV_SECGROUPS={{ env_zone_secgroups }} ENV_COMMENT='{{ env_comment | regex_replace(' ', '_') }}' ENV_ACTION=retrieve
    - name: debug up front
      debug: msg="VLAN up front is "{{ env_guestnetvlan }}"


- hosts: xenserver_hosts
  gather_facts: no
  vars:
    num_xen_hosts: "{{ groups['xenserver_hosts'] | length }}"
    basic_vlan_fromdb: "{{ env_guestnetvlan }}"
    basic_vlan_fromdpl: "77"
  roles:
    - { role: xenserver2, when: num_xen_hosts | int != 0 }
